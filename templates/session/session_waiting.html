{% extends "base.html" %}
{% block content %}
<h2>–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤</h2>
<p>–•–æ—Å—Ç: {{ session.host.username }}</p>
<p>–í–∏–∫—Ç–æ—Ä–∏–Ω–∞: {{ session.session.title }}</p>
<p><strong>–ö–æ–¥ —Å–µ—Å—Å–∏–∏:</strong> {{ session.code }}</p>

{% if is_host %}
  <form method="post" action="">
    {% csrf_token %}
    –í—Ä–µ–º—è –Ω–∞ –≤–æ–ø—Ä–æ—Å: <input type="number" name="time" value="{{ session.time_per_question }}"> —Å–µ–∫—É–Ω–¥<br>
    –ú–∞–∫—Å–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤: <input type="number" name="limit" value="{{ session.max_players }}"><br>
    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </form>
{% endif %}

<ul id="player-list">
  {% for player in session.players.all %}
    <li data-user-id="{{ player.user.id }}">
      {{ player.user.username }}
      {% if is_host and player.user != session.host %}
        <button onclick="kickPlayer({{ player.user.id }})">üóëÔ∏è</button>
      {% endif %}
    </li>
  {% endfor %}
</ul>

{% if is_host %}
  <button id="start-btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
{% endif %}

<script>
    function updatePlayers() {
    fetch("{% url 'get_session_players' session.id %}")
        .then(res => res.json())
        .then(data => {
        const list = document.getElementById('player-list');
        list.innerHTML = '';
        data.players.forEach(player => {
            const li = document.createElement('li');
            li.textContent = player.username;
            {% if is_host %}
            if (player.id !== {{ session.host.id }}) {
            const btn = document.createElement('button');
            btn.textContent = 'üóëÔ∏è';
            btn.onclick = () => kickPlayer(player.id);
            li.appendChild(btn);
            }
            {% endif %}
            list.appendChild(li);
        });

        if (data.started) {
            window.location.href = "{% url 'session_play' session.id %}";
        }
        });
    }

    function kickPlayer(userId) {
    fetch("{% url 'kick_player' session.id %}", {
        method: 'POST',
        headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'user_id=' + userId
    }).then(() => updatePlayers());
    }

    {% if is_host %}
    document.getElementById('start-btn').onclick = function () {
    fetch("{% url 'session_start' session.id %}", {
        method: 'POST',
        headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        }
    }).then(() => window.location.href = "{% url 'session_play' session.id %}");
    };
    {% endif %}

    setInterval(updatePlayers, 2000);
</script>
{% endblock %}